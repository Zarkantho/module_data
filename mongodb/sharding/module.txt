###### sharding ######


# Helper classes to delete a range of documents. This is used for example in chunk migrations
# when we are cleaning up an old chunk.
src/mongo/db/range_deleter.cpp (mongod and tools)
src/mongo/db/range_deleter.h
src/mongo/db/range_deleter_db_env.cpp (mongod and tools)
src/mongo/db/range_deleter_db_env.h
src/mongo/db/range_deleter_mock_env.cpp (mongod and tools)
src/mongo/db/range_deleter_mock_env.h
src/mongo/db/range_deleter_service.cpp (mongod and tools)
src/mongo/db/range_deleter_service.h
src/mongo/db/range_deleter_stat_test.cpp (not built in anywhere)
src/mongo/db/range_deleter_stats.cpp (mongod and tools)
src/mongo/db/range_deleter_stats.h
src/mongo/db/range_deleter_test.cpp (not built in anywhere)
src/mongo/db/range_preserver.h

# Utilities for comparing ranges. Useful because our sharding is range based.
## okay, but why in s/ ? only used by sharding? seems weird that something
## general like range arith is only in s/ but the more specific delete-range
## isn't.
src/mongo/s/range_arithmetic.cpp (mongod, mongos, and tools)
src/mongo/s/range_arithmetic.h
src/mongo/s/range_arithmetic_test.cpp (not built in anywhere)

# Contains metadata about a collection, particularly for sharding. The MetadataLoader populates new
# CollectionMetadata objects from config server data.

src/mongo/s/collection_metadata.cpp (mongod and tools)
src/mongo/s/collection_metadata.h
src/mongo/s/collection_metadata_test.cpp (not built in anywhere)
src/mongo/s/metadata_loader.cpp (mongod and tools)
src/mongo/s/metadata_loader.h
src/mongo/s/metadata_loader_test.cpp (not built in anywhere)

# Code to upgrade config server metadata

src/mongo/s/config_upgrade.cpp (mongos)
src/mongo/s/config_upgrade.h
src/mongo/s/config_upgrade_helpers.cpp (mongos)
src/mongo/s/config_upgrade_helpers.h
src/mongo/s/config_upgrade_v0_to_v5.cpp (mongos)
src/mongo/s/config_upgrade_v4_to_v5.cpp (mongos)

# Distributed lock (lock on the config servers from mongos, i.e. "balancer lock")

src/mongo/s/distlock.cpp
src/mongo/s/distlock.h
src/mongo/s/distlock_test.cpp

# Parser for fields in a BSON object. Meant to help enforce a schema on a BSON object.

src/mongo/db/field_parser-inl.h
src/mongo/db/field_parser.cpp (mongod, mongos, and tools)
src/mongo/db/field_parser.h
src/mongo/db/field_parser_test.cpp (not built in anywhere)

# "Schema" for config server metadata. These classes contain structural class definitions for what
# we expect to find on the config server. They use the field parser above to convert BSON fields
# into C++ members.

src/mongo/s/type_changelog.cpp (mongod, mongos, and tools)
src/mongo/s/type_changelog.h
src/mongo/s/type_changelog_test.cpp (not built in anywhere)
src/mongo/s/type_chunk.cpp (mongod, mongos, and tools)
src/mongo/s/type_chunk.h
src/mongo/s/type_chunk_test.cpp (not built in anywhere)
src/mongo/s/type_collection.cpp (mongod, mongos, and tools)
src/mongo/s/type_collection.h
src/mongo/s/type_collection_test.cpp (not built in anywhere)
src/mongo/s/type_config_version.cpp (mongod, mongos, and tools)
src/mongo/s/type_config_version.h
src/mongo/s/type_config_version_test.cpp (not built in anywhere)
src/mongo/s/type_database.cpp (mongod, mongos, and tools)
src/mongo/s/type_database.h
src/mongo/s/type_database_test.cpp (not built in anywhere)
src/mongo/s/type_lockpings.cpp (mongod, mongos, and tools)
src/mongo/s/type_lockpings.h
src/mongo/s/type_lockpings_test.cpp (not built in anywhere)
src/mongo/s/type_locks.cpp (mongod, mongos, and tools)
src/mongo/s/type_locks.h
src/mongo/s/type_locks_test.cpp (not built in anywhere)
src/mongo/s/type_mongos.cpp (mongod, mongos, and tools)
src/mongo/s/type_mongos.h
src/mongo/s/type_mongos_test.cpp (not built in anywhere)
src/mongo/s/type_settings.cpp (mongod, mongos, and tools)
src/mongo/s/type_settings.h
src/mongo/s/type_settings_test.cpp (not built in anywhere)
src/mongo/s/type_shard.cpp (mongod, mongos, and tools)
src/mongo/s/type_shard.h
src/mongo/s/type_shard_test.cpp (not built in anywhere)
src/mongo/s/type_tags.cpp (mongod, mongos, and tools)
src/mongo/s/type_tags.h
src/mongo/s/type_tags_test.cpp (not built in anywhere)

# Bizarre legacy sharding code.
#
# From writeback_listener.h
# "The writeback listener takes back write attempts that were made against a wrong shard.
# (Wrong here in the sense that the target chunk moved before this mongos had a chance to
# learn so.) It is responsible for reapplying these writes to the correct shard."
#
# So basically, the mongos sends an operation to the mongod, and the writeback listener (running on
# the mongos) says to the mongod every now and again, "yo, have I screwed up recently?". The mongod
# is then like "yeah bro, you screwed up, you wrote all these things to the wrong place and the
# writeback listener is like "thanks man" and tries to write them to the correct shard. Meanwhile
# the user is like "I'm so glad my data was written". This should go away because of the new write
# commands.
## rofl
src/mongo/s/writeback_listener.cpp (mongos)
src/mongo/s/writeback_listener.h

# mongod component of writeback listener

src/mongo/s/d_writeback.cpp (mongod and tools)
src/mongo/s/d_writeback.h

# Sharding code? TODO: verify that this is all sharding related and document the architecture.

src/mongo/s/balance.cpp (mongos)
src/mongo/s/balance.h
src/mongo/s/balancer_policy.cpp (mongos)
src/mongo/s/balancer_policy.h
src/mongo/s/balancer_policy_tests.cpp (not built in anywhere)
src/mongo/s/bson_serializable.h
src/mongo/s/chunk.cpp (mongod, mongos, and tools)
src/mongo/s/chunk.h
src/mongo/s/chunk_diff-inl.cpp (not built in anywhere)
src/mongo/s/chunk_diff.h
src/mongo/s/chunk_diff_test.cpp (not built in anywhere)
src/mongo/s/chunk_manager_targeter.cpp (mongod, mongos, and tools)
src/mongo/s/chunk_manager_targeter.h
src/mongo/s/chunk_version.h
src/mongo/s/chunk_version_test.cpp (not built in anywhere)
src/mongo/s/cluster_client_internal.cpp (mongos)
src/mongo/s/cluster_client_internal.h
src/mongo/s/cluster_write.cpp (mongod, mongos, and tools)
src/mongo/s/cluster_write.h
src/mongo/s/commands/auth_schema_upgrade_s.cpp
src/mongo/s/commands/cluster_hint_cmd.cpp
src/mongo/s/commands/cluster_merge_chunks_cmd.cpp (mongos)
src/mongo/s/commands/cluster_plan_cache_cmd.cpp
src/mongo/s/config.cpp (mongod, mongos, and tools)
src/mongo/s/config.h
src/mongo/s/config_server_checker_service.cpp (mongod, mongos, and tools)
src/mongo/s/config_server_checker_service.h
src/mongo/s/config_server_tests.cpp (not built in anywhere)
src/mongo/s/cursors.cpp (mongos)
src/mongo/s/cursors.h
src/mongo/s/d_logic.cpp (mongod and tools)
src/mongo/s/d_logic.h
src/mongo/s/d_merge.cpp (mongod and tools)
src/mongo/s/d_merge.h
src/mongo/s/d_migrate.cpp (mongod and tools)
src/mongo/s/d_split.cpp (mongod and tools)
src/mongo/s/d_state.cpp (mongod and tools)
src/mongo/s/dbclient_multi_command.cpp (mongod, mongos, and tools)
src/mongo/s/dbclient_multi_command.h
src/mongo/s/dbclient_shard_resolver.cpp (mongod, mongos, and tools)
src/mongo/s/dbclient_shard_resolver.h
src/mongo/s/default_version.cpp (mongod and tools)
src/mongo/s/grid.cpp (mongod, mongos, and tools)
src/mongo/s/grid.h
src/mongo/s/mock_multi_write_command.h
src/mongo/s/mock_ns_targeter.h
src/mongo/s/mock_shard_resolver.h
src/mongo/s/mongo_version_range.cpp (mongod, mongos, and tools)
src/mongo/s/mongo_version_range.h
src/mongo/s/mongo_version_range_test.cpp (not built in anywhere)
src/mongo/s/mongos_persistence_stubs.cpp (mongos)
src/mongo/s/multi_command_dispatch.h
src/mongo/s/ns_targeter.h
src/mongo/s/request.cpp (mongos)
src/mongo/s/request.h
src/mongo/s/shard.cpp (mongod, mongos, and tools)
src/mongo/s/shard.h
src/mongo/s/shard_conn_test.cpp (not built in anywhere)
src/mongo/s/shard_key_pattern.cpp (mongod, mongos, and tools)
src/mongo/s/shard_key_pattern.h
src/mongo/s/shard_resolver.h
src/mongo/s/shard_test.cpp (not built in anywhere)
src/mongo/s/shardconnection.cpp (mongod, mongos, and tools)
src/mongo/s/shardkey.cpp (mongod, mongos, and tools)
src/mongo/s/shardkey.h
src/mongo/s/stale_exception.h
src/mongo/s/strategy.cpp (mongos)
src/mongo/s/strategy.h
src/mongo/s/version_manager.cpp (mongos)
src/mongo/s/version_manager.h
src/mongo/s/version_mongos.cpp (mongos)
src/mongo/s/version_mongos.h


